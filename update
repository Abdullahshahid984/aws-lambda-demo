```groovy
environment {
        FUNCTION_NAME = 'hey-world-demo'
        REGION = 'us-east-1'
        SONAR_PROJECT_KEY = "aws-lambda"
        SONAR_ORG = "your-org"
        ZIP_FILE = "lambda_package.zip"
    }


stage('Deploy to AWS Lambda') {
    steps {
        script {
            def credId = '' // Note: Fixed typo from 'credsId' to match below ('credId')
            def lambdaRole = ''
            def functionName = "${env.FUNCTION_NAME}-${params.ENV}"

            if (params.ENV == 'devtest') {
                credId = 'aws-nonprod-accesskey'
                lambdaRole = 'arn:aws:iam:297322678787:role/full-access'
            } else if (params.ENV == 'stage') {
                credId = 'aws-nonprod-accesskey'
                lambdaRole = 'arn:aws:iam:297322678787:role/lambda-nonprod-role' // Fixed typo
            } else if (params.ENV == 'prod') {
                credId = 'aws-prod-accesskey'
                lambdaRole = 'arn:aws:iam:313923649386:role/lambda-prod-role' // Fixed typo
            }

            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: credId, accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                sh """
                    export AWS_DEFAULT_REGION=\$REGION
                    # Check if function exists, create if it doesn't
                    if ! aws lambda get-function --function-name '${functionName}' > /dev/null 2>&1; then
                        echo "Creating new lambda function: ${functionName}"
                        aws lambda create-function \\
                            --function-name '${functionName}' \\
                            --runtime python3.13 \\
                            --role '${lambdaRole}' \\
                            --handler lambda_handler.lambda_handler \\
                            --zip-file fileb://lambda_package.zip
                    else
                        echo "Function ${functionName} exists, updating code."
                        aws lambda update-function-code \\
                            --function-name '${functionName}' \\
                            --zip-file fileb://lambda_package.zip
                    fi
                """
            }
        }
    }
}
stage('Setup CloudWatch Schedule') {
            steps {
                script {
                    def credsId = ''

                    if (params.ENV == 'dev') {
                        credsId = 'aws-cred-dev'
                    } else if (params.ENV == 'stage') {
                        credsId = 'aws-cred-stage'
                    } else if (params.ENV == 'prod') {
                        credsId = 'aws-cred-prod'
                    }

                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: credId, accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                        sh '''
                        export AWS_DEFAULT_REGION=$REGION
                        FUNCTION_NAME="{functionName}"
                        RULE_NAME="hello-world-schedule-${ENV}"
                        SCHEDULE="rate(5 minutes)"
                        STATEMENT_ID="cw-invoke-${ENV}"

                        # Create or update CloudWatch rule
                        aws events put-rule \
                            --name $RULE_NAME \
                            --schedule-expression "$SCHEDULE" \
                            --state ENABLED

                        # Resolve Lambda ARN
                        FUNCTION_ARN=$(aws lambda get-function --function-name '${functionName}' --query 'Configuration.FunctionArn' --output text)

                        # Add Lambda as target of the rule
                        aws events put-targets \
                            --rule $RULE_NAME \
                            --targets "Id"="1","Arn"=$FUNCTION_ARN

                        # Resolve Rule ARN
                        SOURCE_ARN=$(aws events describe-rule --name $RULE_NAME --query 'Arn' --output text)

                        # Check if permission already exists
                        if ! aws lambda get-policy --function-name '${functionName}' | grep -q $STATEMENT_ID; then
                            echo "Adding new permission: $STATEMENT_ID"
                            aws lambda add-permission \
                                --function-name '${functionName}'\
                                --statement-id $STATEMENT_ID \
                                --action 'lambda:InvokeFunction' \
                                --principal events.amazonaws.com \
                                --source-arn $SOURCE_ARN
                        else
                            echo "Permission $STATEMENT_ID already exists, skipping..."
                        fi
                        '''
                    }
                }
            }
        }

    }
}
