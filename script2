stage('Setup CloudWatch Schedule') {
    steps {
        script {
            // Map env â†’ creds + role (keep same pattern as deploy stage)
            if (params.ENV.toLowerCase() == 'stage') {
                credId = 'aws-stage-accesskey'
                env.FUNCTION_NAME = "my-lambda-stage"
                env.LAMBDA_ROLE   = "arn:aws:iam::222222222222:role/lambda-stage-role"
            } else if (params.ENV.toLowerCase() == 'prod') {
                credId = 'aws-prod-accesskey'
                env.FUNCTION_NAME = "my-lambda-prod"
                env.LAMBDA_ROLE   = "arn:aws:iam::333333333333:role/lambda-prod-role"
            } else {
                credId = 'aws-test-accesskey'
                env.FUNCTION_NAME = "my-lambda-test"
                env.LAMBDA_ROLE   = "arn:aws:iam::111111111111:role/lambda-test-role"
            }

            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: credId,
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
                sh """
                    set -e

                    echo "Fetching Lambda ARN..."
                    LAMBDA_ARN=\$(aws lambda get-function \
                        --function-name ${env.FUNCTION_NAME} \
                        --region ${env.REGION} \
                        --query 'Configuration.FunctionArn' \
                        --output text)

                    echo "Creating CloudWatch Events rule..."
                    aws events put-rule \
                        --schedule-expression "rate(15 minutes)" \
                        --name ${env.FUNCTION_NAME}-schedule \
                        --region ${env.REGION}

                    echo "Adding permission for CloudWatch to invoke Lambda..."
                    aws lambda add-permission \
                        --function-name ${env.FUNCTION_NAME} \
                        --statement-id ${env.FUNCTION_NAME}-event \
                        --action lambda:InvokeFunction \
                        --principal events.amazonaws.com \
                        --region ${env.REGION} || true

                    echo "Creating target for CloudWatch Events..."
                    aws events put-targets \
                        --rule ${env.FUNCTION_NAME}-schedule \
                        --targets "Id"="1","Arn"="\$LAMBDA_ARN" \
                        --region ${env.REGION}

                    echo "CloudWatch schedule setup completed for ${params.ENV}"
                """
            }
        }
    }
}
