stage('Deploy Lambda Function') {
    steps {
        withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: credId,
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
            script {
                try {
                    sh """
                        # Create Lambda deployment package
                        echo "Creating Lambda deployment package..."
                        zip -r ${env.ZIP_FILE} lambda_function.py src/ config/ -x "*/__pycache__/*" "*.pyc" "*.pyo"
                        echo "ZIP file created: \$(ls -la ${env.ZIP_FILE})"
                       
                        # Check if function exists
                        echo "Checking if Lambda function exists: ${env.FUNCTION_NAME}"
                       
                        # Use aws lambda list-functions to check existence more reliably
                        if aws lambda get-function --function-name ${env.FUNCTION_NAME} --region ${env.REGION} 2>/dev/null; then
                            echo "Function exists, updating..."
                            aws lambda update-function-code \\
                                --function-name ${env.FUNCTION_NAME} \\
                                --zip-file fileb://${env.ZIP_FILE} \\
                                --region ${env.REGION}
                           
                            echo "Waiting for function to be active..."
                            aws lambda wait function-active \\
                                --function-name ${env.FUNCTION_NAME} \\
                                --region ${env.REGION}
                           
                            echo "Lambda function updated successfully"
                        else
                            echo "Function does not exist, creating..."
                            aws lambda create-function \\
                                --function-name ${env.FUNCTION_NAME} \\
                                --runtime python3.9 \\
                                --role ${env.LAMBDA_ROLE} \\
                                --handler lambda_function.lambda_handler \\
                                --zip-file fileb://${env.ZIP_FILE} \\
                                --timeout 30 \\
                                --memory-size 256 \\
                                --region ${env.REGION}
                           
                            echo "Lambda function created successfully"
                        fi
                       
                        # Verify deployment
                        echo "Verifying Lambda deployment..."
                        aws lambda get-function \\
                            --function-name ${env.FUNCTION_NAME} \\
                            --region ${env.REGION} \\
                            --query 'Configuration.[FunctionName,Runtime,LastModified]' \\
                            --output table
                }
            }
        }
    }
}
