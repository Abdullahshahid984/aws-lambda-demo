stage('Deploy Lambda Function') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-credentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    script {
                        def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                       
                        def functionExists = sh(
                            script: """
                                aws lambda get-function \
                                    --function-name "${FUNCTION_NAME}" \
                                    --region ${env.REGION} \
                                    --query 'Configuration.FunctionName' \
                                    --output text 2>/dev/null || echo "NOT_FOUND"
                            """,
                            returnStdout: true
                        ).trim()
                       
                        if (functionExists == "NOT_FOUND") {
                            echo "Creating new Lambda function: ${FUNCTION_NAME}"
                            sh """
                                aws lambda create-function \
                                    --function-name "${FUNCTION_NAME}" \
                                    --runtime python3.9 \
                                    --role "${env.LAMBDA_ROLE_ARN}" \
                                    --handler ${env.LAMBDA_HANDLER} \
                                    --zip-file fileb://${env.ZIP_FILE} \
                                    --region ${env.REGION}
                            """
                        } else {
                            echo "Updating existing Lambda function: ${FUNCTION_NAME}"
                            sh """
                                aws lambda update-function-code \
                                    --function-name "${FUNCTION_NAME}" \
                                    --zip-file fileb://${env.ZIP_FILE} \
                                    --region ${env.REGION}
                            """
                        }
                    }
                }
            }
        }
       
        stage('Verify Deployment') {
            steps {
                script {
                    def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                    def maxRetries = 30
                    def retryCount = 0
                   
                    while (retryCount < maxRetries) {
                        def status = sh(
                            script: """
                                aws lambda get-function-configuration \
                                    --function-name "${FUNCTION_NAME}" \
                                    --region ${env.REGION} \
                                    --query 'State' \
                                    --output text 2>/dev/null || echo "Pending"
                            """,
                            returnStdout: true
                        ).trim()
                       
                        if (status == 'Active') {
                            echo "Lambda function is Active"
                            break
                        }
                       
                        sleep(5)
                        retryCount++
                    }
                }
            }
        }
       
        stage('Test Lambda Function') {
            steps {
                script {
                    def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                   
                    sh """
                        aws lambda invoke \
                            --function-name "${FUNCTION_NAME}" \
                            --region ${env.REGION} \
                            --payload '{"test": "event"}' \
                            /tmp/lambda_response.json \
                            && echo "Lambda test invocation successful" \
                            || echo "Lambda invocation failed (may be expected for new functions)"
                    """
                }
            }
        }
    }
stage('Setup CloudWatch Schedule') {
    steps {
        withCredentials([[ 
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-credentials',
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
            script {
                def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                def RULE_NAME = "${FUNCTION_NAME}-schedule"

                // Fetch AWS account ID dynamically
                def awsAccountId = sh(
                    script: """
                        aws sts get-caller-identity \
                            --query 'Account' \
                            --output text \
                            --region ${env.REGION}
                    """,
                    returnStdout: true
                ).trim()

                echo "Setting up CloudWatch schedule for ${FUNCTION_NAME}"

                // Create or update rule
                sh """
                    aws events put-rule \
                        --name "${RULE_NAME}" \
                        --schedule-expression "rate(15 minutes)" \
                        --state ENABLED \
                        --region ${env.REGION}
                """

                // Add Lambda target
                sh """
                    aws events put-targets \
                        --rule "${RULE_NAME}" \
                        --targets Id="1",Arn="arn:aws:lambda:${env.REGION}:${awsAccountId}:function:${FUNCTION_NAME}" \
                        --region ${env.REGION}
                """

                // Add permission (ignore if already exists)
                sh """
                    aws lambda add-permission \
                        --function-name "${FUNCTION_NAME}" \
                        --statement-id "cloudwatch-${RULE_NAME}" \
                        --action "lambda:InvokeFunction" \
                        --principal "events.amazonaws.com" \
                        --source-arn "arn:aws:events:${env.REGION}:${awsAccountId}:rule/${RULE_NAME}" \
                        --region ${env.REGION} || echo "Permission already exists"
                """

                echo "CloudWatch schedule configured successfully"
            }
        }
    }
}
