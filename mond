stage('Deploy Lambda Function') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-credentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    script {
                        def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                       
                        def functionExists = sh(
                            script: """
                                aws lambda get-function \
                                    --function-name "${FUNCTION_NAME}" \
                                    --region ${env.REGION} \
                                    --query 'Configuration.FunctionName' \
                                    --output text 2>/dev/null || echo "NOT_FOUND"
                            """,
                            returnStdout: true
                        ).trim()
                       
                        if (functionExists == "NOT_FOUND") {
                            echo "Creating new Lambda function: ${FUNCTION_NAME}"
                            sh """
                                aws lambda create-function \
                                    --function-name "${FUNCTION_NAME}" \
                                    --runtime python3.9 \
                                    --role "${env.LAMBDA_ROLE_ARN}" \
                                    --handler ${env.LAMBDA_HANDLER} \
                                    --zip-file fileb://${env.ZIP_FILE} \
                                    --region ${env.REGION}
                            """
                        } else {
                            echo "Updating existing Lambda function: ${FUNCTION_NAME}"
                            sh """
                                aws lambda update-function-code \
                                    --function-name "${FUNCTION_NAME}" \
                                    --zip-file fileb://${env.ZIP_FILE} \
                                    --region ${env.REGION}
                            """
                        }
                    }
                }
            }
        }
       
        stage('Verify Deployment') {
            steps {
                script {
                    def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                    def maxRetries = 30
                    def retryCount = 0
                   
                    while (retryCount < maxRetries) {
                        def status = sh(
                            script: """
                                aws lambda get-function-configuration \
                                    --function-name "${FUNCTION_NAME}" \
                                    --region ${env.REGION} \
                                    --query 'State' \
                                    --output text 2>/dev/null || echo "Pending"
                            """,
                            returnStdout: true
                        ).trim()
                       
                        if (status == 'Active') {
                            echo "Lambda function is Active"
                            break
                        }
                       
                        sleep(5)
                        retryCount++
                    }
                }
            }
        }
       
        stage('Test Lambda Function') {
            steps {
                script {
                    def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                   
                    sh """
                        aws lambda invoke \
                            --function-name "${FUNCTION_NAME}" \
                            --region ${env.REGION} \
                            --payload '{"test": "event"}' \
                            /tmp/lambda_response.json \
                            && echo "Lambda test invocation successful" \
                            || echo "Lambda invocation failed (may be expected for new functions)"
                    """
                }
            }
        }
    }
