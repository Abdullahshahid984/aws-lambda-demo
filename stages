stage('Install Requirements') {
    steps {
        script {
            reqMap.each { layerName, layerConfig ->
                if (layerName != 'all') {
                    dir(env.WORKSPACE) {
                        sh """
                            echo "Installing dependencies for ${layerName} layer with AWS-recommended structure..."
                            mkdir -p python/lib/python3.9
                            if [ -f "requirements-${layerName}.txt" ]; then
                                pip3.9 install -r requirements-${layerName}.txt -t python/lib/python3.9 --no-deps
                            else
                                echo "requirements-${layerName}.txt not found, skipping..."
                            fi
                        """
                    }
                }
            }
        }
    }
}
stage('Package Layers') {
    steps {
        script {
            reqMap.each { layerName, layerConfig ->
                if (layerName != 'all') {
                    dir(env.WORKSPACE) {
                        sh """
                            echo "Packaging ${layerName} layer with AWS structure..."
                            zip -r ${layerConfig.zip} python -x ${layerConfig.exclude}
                            # Clean up the python directory for next layer
                            rm -rf python
                        """
                    }
                }
            }
        }
    }
}

stage('Publish Layers') {
    steps {
        script {
            reqMap.each { layerName, layerConfig ->
                if (layerName != 'all') {
                    sh """
                        aws lambda publish-layer-version \
                            --layer-name ${layerName} \
                            --zip-file fileb://${layerConfig.zip} \
                            --compatible-runtimes python3.9 \
                            --region ${env.REGION} \
                            --query 'LayerVersionArn' \
                            --output text > ${layerName}_arn.txt
                    """
                   
                    def layerArn = readFile("${layerName}_arn.txt").trim()
                    layerArns[layerName] = layerArn
                }
            }
        }
    }
}

parameters {
    string defaultValue: 'develop', description: 'Select git branch', name: 'GIT_BRANCH', trim: true
    choice(name: 'ENV', choices: ['devtest', 'stage', 'prod'], description: 'Choose deployment environment')
    string defaultValue: '5', description: 'Schedule interval in minutes', name: 'SCHEDULE_MINUTES', trim: true
}

// Add this environment variable
environment {
    BASE_FUNCTION_NAME = 'lambda-function'
    REGION = 'us-east-1'
    ZIP_FILE = 'lambda_package.zip'
    AWS_ACCOUNT_ID = 'your-aws-account-id'
    AMS_ACCOUNT_ID = 'your-ams-account-id'  // â† Add this if different from AWS_ACCOUNT_ID
    LAMBDA_ROLE_ARN = "${roleConfig[params.ENV]}"
    LAMBDA_HANDLER = 'lambda_handler.lambda_handler'
}

// Add this stage after 'Test Lambda Function'
stage("Setup CloudWatch Schedule") {
    steps {
        withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws ccesskey',
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
            script {
                def FUNCTION_NAME = "${env.BASE_FUNCTION_NAME}-${params.ENV}"
                def RULE_NAME = "${FUNCTION_NAME}-schedule"  // Dynamic rule name
                def SCHEDULE_EXPRESSION = "rate(15 minutes)"
               
                echo "Creating CloudWatch Events rule: ${RULE_NAME}"
               
                sh """
                    # Read Lambda ARN from file (as in your working version)
                    LAMBDA_ARN=\$(cat ${env.ARN_FILE})
                   
                    # Create CloudWatch rule
                    aws events put-rule \
                        --schedule-expression "${SCHEDULE_EXPRESSION}" \
                        --name "${RULE_NAME}" \
                        --region ${env.REGION} \
                        --description "Schedule for ${FUNCTION_NAME} in ${params.ENV} environment"
                   
                    # Add permission for CloudWatch to invoke Lambda
                    aws lambda add-permission \
                        --function-name ${FUNCTION_NAME} \
                        --statement-id "cloudwatch-${RULE_NAME}" \
                        --action lambda:InvokeFunction \
                        --principal events.amazonaws.com \
                        --source-arn "arn:aws:events:${env.REGION}:\$(echo \$LAMBDA_ARN | cut -d: -f5):rule/${RULE_NAME}" \
                        --region ${env.REGION} 2>/dev/null || echo "Permission already exists"
                   
                    # Create target for CloudWatch Events
                    aws events put-targets \
                        --rule "${RULE_NAME}" \
                        --targets Id="1",Arn="\$LAMBDA_ARN" \
                        --region ${env.REGION}
                """
               
                echo "CloudWatch schedule configured: ${RULE_NAME} for ${FUNCTION_NAME}"
            }
        }
    }
}
```
